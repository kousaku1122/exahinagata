<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A cool thing made with Glitch">
    <link rel="stylesheet" href="style.css" />
    <title>アプリケーション雛形</title>
  </head>
  <body>
    <header>
      <h1>
        exaインターン作品
      </h1>
      <p>
      サインアップは<a href="/signup">こちら</a>
    </p>
      <p>
        ログインは<a href="/login">こちら</a>
      </p>
      <a id="logout" href="/logout">ログアウト</a>
    </header>
    <div class="main-wrapper">
      <h2>ひながた</h2>
      <div class="border">
        <input id="userName" type="text"  placeholder="ユーザー名" />
        <input id="userText" type="text"  placeholder="感想" />
        <input type="image" src="https://cdn.glitch.com/d154a165-8425-4193-9d81-22023483f698%2Fpush.png?v=1601020722972" alt="送信する" onclick="saveUser()" />
      </div>

      <div id="list"></div>
      <!-- リスト表示部 -->
    </div>
    <footer>
      &copy;KOKI SAKURAI
    </footer>
    <script>
      window.onload = findUsers; // 画面ロード時に実行
        
      if( !document.cookie){
        const logout = document.getElementById('logout');
        logout.style.display = 'none';
        let buttons = document.getElementsByClassName('button');
        for(let i in buttons){
          let button = buttons[i];
          buttons[i].style.display = 'none';
        }
      }
      
      const listArea = document.getElementById("list"); // リスト表示部

      // ユーザの保存
      function saveUser() {
        // 名前をテキストボックスから取得（要素.value）
        const textBox1 = document.getElementById("userName");
        const textBox2 = document.getElementById("userText");
        const userName = textBox1.value;
        const userText = textBox2.value;

        // 取得した情報をもとにオブジェクトを作る
        const user = { name: userName, text: userText };

        const url = "/saveUser"; // 通信先
        const req = new XMLHttpRequest(); // 通信用オブジェクト

        req.onreadystatechange = function() {
          if (req.readyState == 4 && req.status == 200) {
            addToList(userName, userText, req.response);
          }
        };
        req.open("POST", url, true);
        req.setRequestHeader("Content-Type", "application/json");
        req.send(JSON.stringify(user)); // オブジェクトを文字列化して送信
      }

      // 全ユーザの取得
      function findUsers() {
        const url = "/findUsers"; // 通信先
        const req = new XMLHttpRequest(); // 通信用オブジェクト

        req.onreadystatechange = function() {
          if (req.readyState == 4 && req.status == 200) {
            const users = JSON.parse(req.response);
            for (let i in users) {
              const user = users[i];
              addToList(user.name, user.text, user._id);
            }
          }
        };
        req.open("GET", url, true);
        req.send();
      }

      function deleteUser(id) {
        const user = { id: id };

        const url = "/deleteUser"; // 通信先
        const req = new XMLHttpRequest(); // 通信用オブジェクト

        req.onreadystatechange = function() {
          if (req.readyState == 4 && req.status == 200) {
            const target = document.getElementById(id); // ID で要素を特定
            target.parentNode.removeChild(target); // 親要素に自分を削除させる
          }
        };
        req.open("POST", url, true);
        req.setRequestHeader("Content-Type", "application/json");
        req.send(JSON.stringify(user)); // オブジェクトを文字列化して送信
      }

      function addToList(userName, userText, id) {
        const userDiv = document.createElement("div"); // 追加するユーザの div 要素
        userDiv.id = id; // ID を付与する

        const nameSpan = document.createElement("span");
        nameSpan.innerText = userName + " さん";

        const textSpan = document.createElement("span");
        textSpan.innerText = userText;
        
        const delButton = document.createElement("button");
        delButton.className ='button';
        delButton.innerText = "削除";
        delButton.onclick = function() {          
          const result = window.confirm("本当に削除しますか");
          if( result ) {
            deleteUser(id); // ID を利用して削除
          }
          else {
          }
        };

        userDiv.appendChild(nameSpan); // userDiv に名前を追加
        userDiv.appendChild(textSpan);
        userDiv.appendChild(delButton); // userDiv に削除ボタンを追加
        listArea.appendChild(userDiv); // リストに userDiv を追加
      }
      
    </script>
  </body>
</html>
